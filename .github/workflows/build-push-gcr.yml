name: Build & push to gcr
on:
    workflow_call:
        inputs:
            image_name:
                required: true
                type: string
        secrets:
            GCLOUD_SERVICE_KEY:
                required: true

jobs:
    build-and-push-to-gcr:
        runs-on: ubuntu-latest
        steps:
            - name: base64 encode the gcr sa
              id: base64-encode
              run: |
                echo "::set-output name=BRANCH_BASE64::$(echo -n ${{ github.head_ref || github.ref_name }} | base64 | sed 's/=//g')"
                echo "::set-output name=SHA_SHORT::$(git rev-parse --short HEAD)"
              

            - uses: actions/checkout@v2
            - name: 'Build'
              uses: RafikFarhad/push-to-gcr-github-action@v4.1
              with:
                  gcloud_service_key: ${{ secrets.GCLOUD_SERVICE_KEY }} # can be base64 encoded or plain text
                  registry: eu.gcr.io
                  project_id: cavea-227821
                  image_name: ${{ inputs.image_name }}
                  image_tag: ${{ steps.base64-encode.outputs.BRANCH_BASE64 }}.${{ steps.base64-encode.outputs.SHA_SHORT }}
                  dockerfile: Dockerfile
                  context: .
