name: Deploy to cloud run
on:
    workflow_call:
        secrets:
            GCP_SA_KEY:
                required: true

jobs:
    deploy-to-cloud-run:
        permissions:
          contents: 'read'
          id-token: 'write'
        runs-on: ubuntu-latest
        steps:
          - name: 'base64 encode the gcr sa'
            id: base64-encode
            run: echo "::set-output name=BRANCH_BASE64::$(echo -n ${{ github.head_ref || github.ref_name }} | base64 | sed 's/=//g')"

          - id: 'auth'
            uses: 'google-github-actions/auth@v0.8.3'
            with:
              credentials_json: '${{ secrets.GCP_SA_KEY }}'
          
          - name: Checkout files
            uses: Bhacaz/checkout-files@v2
            with:
                files: deployment.yaml
          
          - name: 'Deploy to Cloud Run'
            uses: 'google-github-actions/deploy-cloudrun@v1.0.0'
            with:
              service: 'editor-service'
              image: 'eu.gcr.io/capturelab/editor-service:${{ steps.base64-encode.outputs.BRANCH_BASE64 }}'
              project_id: capturelab
              region: 'europe-west1'
              metadata: 'deployment.yaml'
